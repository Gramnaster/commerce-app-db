json.status do
  json.code 200
  json.message "Fetched all products successfully"
end

json.pagination @pagination if @pagination

json.data do
  json.array! @products do |product|
    json.id product.id
    json.title product.title
    json.description product.description
    json.price product.price
    json.final_price product.final_price
    json.discount_percentage product.applicable_discount_percentage
    json.discount_amount_dollars product.discount_amount_dollars
    
    # Priority: attached product_image > product_image_url > null
    if product.product_image.attached?
      json.product_image_url url_for(product.product_image)
    else
      json.product_image_url product.product_image_url
    end

    json.product_category do
      json.id product.product_category.id
      json.title product.product_category.title
    end

    json.producer do
      json.id product.producer.id
      json.title product.producer.title
    end

    if product.promotion
      json.promotion do
        json.id product.promotion.id
        json.discount_percentage product.promotion.discount_amount
        json.type "product"
      end
    elsif product.product_category.promotions.any?
      category_promo = product.product_category.promotions.first
      json.promotion do
        json.id category_promo.id
        json.discount_percentage category_promo.discount_amount
        json.type "category"
      end
    else
      json.promotion nil
    end

    json.created_at product.created_at
    json.updated_at product.updated_at
  end
end
